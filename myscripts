--[[
    CRASH-PROOF INTROSPECTION ENGINE (V2)
    Resilient against Userdata Proxies and Metatable errors.
]]

local OUTPUT = {}
local SCANNED_OBJS = {} 
local SAFE_PAIRS_CACHE = {}

-- 1. UTILITY: Safe Iterator
-- If 'pairs' fails (because it's userdata), we try to get the metatable or skip it.
local function safe_pairs(t)
    local success, iter, state, idx = pcall(function() return pairs(t) end)
    if success then
        return iter, state, idx
    else
        return function() return nil end -- Return empty iterator on failure
    end
end

-- 2. UTILITY: Add to Log
local function log(str)
    table.insert(OUTPUT, str)
end

-- 3. CORE LOGIC: Recursive Crawler (Patched)
local function recursive_scan(tbl, path_name)
    -- Sanity Check: If it's not a table or userdata, we can't scan inside it.
    local raw_type = type(tbl)
    if raw_type ~= "table" and raw_type ~= "userdata" then return end

    -- Cycle Protection
    if SCANNED_OBJS[tbl] then return end
    SCANNED_OBJS[tbl] = true

    -- Protected Iteration: The core fix for your error
    local success, err = pcall(function()
        for key, value in pairs(tbl) do
            local key_str = tostring(key)
            local current_path = path_name .. "." .. key_str
            local v_type = type(value) -- Use standard Lua type, not typeof

            -- Filter standard globals to reduce spam
            if key_str ~= "_G" and key_str ~= "shared" and key_str ~= "package" then
                
                if v_type == "function" then
                    -- Check if it is a C function or Lua function
                    local info = "Function"
                    if debug.info then
                        pcall(function()
                            if debug.info(value, "s") == "[C]" then
                                info = "Function [C/Internal]"
                            else
                                info = "Function [Lua]"
                            end
                        end)
                    end
                    log(string.format("[FUNC] %-45s | %s", current_path, info))

                elseif v_type == "table" then
                    log(string.format("[LIB]  %-45s | Table", current_path))
                    recursive_scan(value, current_path)
                
                elseif v_type == "userdata" then
                    -- If we find a userdata, it might be a custom library. 
                    -- We try to scan it, but if pairs fails inside the recursive call, the pcall handles it.
                    log(string.format("[UDATA] %-45s | Userdata (Proxy)", current_path))
                    recursive_scan(value, current_path)
                end
            end
        end
    end)

    if not success then
        log(string.format("!! [ACCESS DENIED] Could not iterate over %s. It is likely locked Userdata.", path_name))
    end
end

-- 4. EXECUTION
local function run_introspection()
    log("==================================================================")
    log("EXECUTOR DIAGNOSTICS V2 (CRASH PROOF)")
    log("Scan Date: " .. os.date("%c"))
    log("==================================================================\n")

    -- A. GLOBAL ENVIRONMENT SCAN
    log("[--- GLOBAL ENVIRONMENT ---]")
    
    -- Attempt to grab environment safely
    local env_root = nil
    if getgenv then 
        pcall(function() env_root = getgenv() end)
    end
    if not env_root then env_root = _G end

    if env_root then
        recursive_scan(env_root, "Global")
    else
        log("CRITICAL: Could not access Global Environment (getgenv/_G failed)")
    end

    -- B. REGISTRY SCAN (Optional)
    if debug and debug.getregistry then
        log("\n[--- LUA REGISTRY DUMP ---]")
        pcall(function()
            local reg = debug.getregistry()
            for i, v in pairs(reg) do
                if type(v) == "function" then
                    -- Only log named C functions to find hidden libraries
                    local n = debug.info(v, "n")
                    if n and #n > 0 then
                        log("[REGISTRY] Found Named Function: " .. n)
                    end
                end
            end
        end)
    end

    -- OUTPUT
    local final_string = table.concat(OUTPUT, "\n")
    
    if setclipboard then
        setclipboard(final_string)
        print("Detailed Report copied to clipboard!")
    elseif toclipboard then
        toclipboard(final_string)
        print("Detailed Report copied to clipboard!")
    else
        print("Clipboard API missing. Printing chunk to console:")
        print(final_string)
    end
end

-- Run safely
task.spawn(run_introspection)
