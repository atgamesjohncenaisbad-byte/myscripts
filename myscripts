--[[
    APEX PREDATOR COMBAT SUITE v6.0
    Detection: Engine-Level Spatial Query (GetPartBoundsInRadius)
    Persistence: Double-Locked Property Enforcement
    Bypass: Zero-Hook Direct Invocation
--]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local lp = Players.LocalPlayer

-- Master Config
local _WS = 40
local _RANGE = 60
local _ATTACK_INTERVAL = 0.03 -- Blazing fast (approx 33 hits per second)
local _MULTI = 1 -- 1 or 2 (to stay under the "Massive Damage" server cap)
local _COMBO = 10

-- Internals
local lastAttack = 0
local Overlap = OverlapParams.new()
Overlap.FilterType = Enum.RaycastFilterType.Include -- We ONLY look at enemies

-- UI Setup
local sg = Instance.new("ScreenGui", lp.PlayerGui)
sg.Name = "ApexHUD"
sg.ResetOnSpawn = false
local frame = Instance.new("Frame", sg)
frame.Size = UDim2.new(0, 220, 0, 60)
frame.Position = UDim2.new(0, 10, 0.05, 0)
frame.BackgroundColor3 = Color3.new(0,0,0)
frame.BackgroundTransparency = 0.5
local status = Instance.new("TextLabel", frame)
status.Size = UDim2.new(1, 0, 1, 0)
status.TextColor3 = Color3.new(1, 1, 1)
status.Font = Enum.Font.Code
status.TextSize = 14
status.BackgroundTransparency = 1
status.Text = "Apex Ready."

-- ATOMIC FUNCTIONS
local function GetEnemiesInRadius(pos)
    local mobsFolder = workspace:FindFirstChild("Mobs ")
    if not mobsFolder then return {} end
    
    -- Tell the engine to only look inside the Mobs folder
    Overlap.FilterDescendantsInstances = {mobsFolder}
    
    -- SPATIAL QUERY: This is the fastest detection method in the engine
    local parts = workspace:GetPartBoundsInRadius(pos, _RANGE, Overlap)
    
    local uniqueEnemies = {}
    local seen = {} -- Prevent hitting the same enemy multiple times per frame
    
    for _, part in ipairs(parts) do
        local model = part:FindFirstAncestorOfClass("Model")
        if model and not seen[model] then
            local hum = model:FindFirstChildOfClass("Humanoid")
            if hum and hum.Health > 0 then
                seen[model] = true
                table.insert(uniqueEnemies, hum)
            end
        end
    end
    return uniqueEnemies
end

-- MAIN ENGINE: Runs every physics step
RunService.Stepped:Connect(function()
    local char = lp.Character
    if not char then return end

    local hum = char:FindFirstChildOfClass("Humanoid")
    local root = char:FindFirstChild("HumanoidRootPart")
    if not hum or not root then return end

    -- 1. WALKSPEED LOCK (Persistent)
    hum.WalkSpeed = _WS

    -- 2. DYNAMIC REMOTE/TOOL SEARCH
    local tool = char:FindFirstChildWhichIsA("Tool")
    -- Check character FIRST, then the tool (handles different game tiers)
    local remote = char:FindFirstChild("SwordDamage") or (tool and tool:FindFirstChild("SwordDamage"))

    if not tool or not remote then
        status.Text = "WAITING: Equip a Sword"
        status.TextColor3 = Color3.new(1, 0.5, 0)
        return
    end

    status.Text = "APEX ACTIVE | RANGE: " .. _RANGE
    status.TextColor3 = Color3.new(0, 1, 0)

    -- 3. COMBAT EXECUTION
    if tick() - lastAttack >= _ATTACK_INTERVAL then
        local targets = GetEnemiesInRadius(root.Position)
        
        for _, enemyHum in ipairs(targets) do
            -- Direct call using your specific dump parameters
            -- target, tool, multi, combo, size, grip
            remote:FireServer(
                enemyHum,
                tool,
                _MULTI,
                _COMBO,
                tool.Handle.Size,
                tool.GripPos
            )
            
            -- Dummy Support (Bypassing specific dummy training caps)
            if enemyHum.Parent:FindFirstChild("dummyScript") then
                local dRemote = game.ReplicatedStorage:FindFirstChild("DummyEvent")
                if dRemote then dRemote:FireServer(100, enemyHum) end
            end
        end
        lastAttack = tick()
    end
end)

-- RESPAWN PERSISTENCE
lp.CharacterAdded:Connect(function(newChar)
    local h = newChar:WaitForChild("Humanoid", 5)
    if h then h.WalkSpeed = _WS end
end)

print("Apex Suite v6.0 Initialized. Spatial Query active.")
